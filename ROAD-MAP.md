#   v2.3 分布式下的一些优化

分布式下选举出一个leader，来处理一些管理工作，例如：维护模式、job的rebalance、故障检测等。
其余的节点以分布式锁的方式准备成为leader。

###     选举leader

选举leader，如果失败，则监听比自己小一号的节点，等待成为leader。由leader来监听所有节点的状态，发现有宕机时负责恢复上面的job。

```
leader_init(){
    // 如果只有自己在运行，则重置一些job的状态
    // 监听所有节点，并在宕机时将运行在上面的job恢复
    // 定期对所有job做故障检测，找出调度异常的job并发送通知
}
```
目前还没有想好leader还有其它事情要做


###     维护模式

由于管理需要，管理员在某些情况下会希望某个jobcenter节点进入维护模式，不再启动新的任务，并且已有的任务也都正确地转移到其它节点。

一般情况下，通过zookeeper启动一个job之前，会获取到每个节点运行的job总数，然后取运行job数量最小的那个节点来启动新job。加入了维护模式以后，在计算节点数量时直接忽略掉维护模式下的节点。

进入维护模式的过程如下：

-   管理员对某个节点发起maintenance命令
-   将该节点标记为维护模式，不再运行新job
-   当前节点接收到命令后，将非active状态的job停止掉，然后转移到其它节点
-   等待active状态的job退出本次运行，然后将其转移到其它节点

管理员可以发送命令将某台服务器退出维护模式。

维护模式这个功能，是集群管理非常重要的一部分，借助它可以实现灰度发布新版本，还可以用来做一些应急管理。


###     job的rebalance（再平衡）

根据job的数量进行rebalance，使每个节点上运行的job的数量尽可能地保持一致，并且在rebalance的过程中，不能打断job的正常运行。过程如下：

-   管理员发起rebalance命令
-   某个节点接收到命令后，计算出某台主机(source host)需要向某台主机(target host)转移N个job，然后将需要转移的任务数和目标主机的信息发送给需要转移的主机
-   source host接收到指令后，监听每个当前主机上的job的运行，每当有job运行结束，就将其转移到target host上运行。
-   直到转移了N个任务，当前source host的转移任务结束

rebalance功能可以进一步提高jobcenter集群的吞吐量和伸缩性。借助这个功能，加入更多节点就可以分摊已有节点的压力，还不会影响已有job的运行。


###     故障检测

leader要负责定期检测job的运行情况，如果某个job是每隔20分钟运行一次，但上次运行的时间距现在已经超过了20分钟，则认为这个job出现了故障。要考虑如何解析cron表达式来获取运行频率。

dummy job的检测：所谓的dummy job，就是在数据库中的状态是RUNNING，而实际上并没有RUNNING的job，故障检测也要覆盖这种job。

zookeeper中保存的各个节点运行job的数量有可能不准确，需要定期来数据库中同步最新的值


###     任务的启动、停止的性能优化

目前在启动和停止job时，总是通过zookeeper来发送命令。
优化方式：如果收到命令的节点和将要执行命令的节点在一台主机上，则不通过zookeeper，而是直接调用相关接口来执行命令。
